<!--
Copyright 2017 Next Century Corporation

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<link rel="import" href="../iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../styled-dialog/styled-dialog.html">
<link rel="import" href="confidence-styles.html">

<!--
A Polymer Element showing the confidence of an extraction that opens a dialog with the provenance details of that extraction.

### Example
```js
var provenances = [{
  method: 'html extraction',
  text: 'the quick brown fox <etk>jumped</etk> over the lazy dog'
}];
```

```html
<confidence-marker
  confidence="100"
  document-id="1234"
  provenances="[[provenances]]">
</confidence-marker>
```

@demo demo/index.html
-->

<dom-module id="confidence-marker">
  <template>
    <style include="confidence-styles"></style>
    <style include="iron-flex iron-flex-alignment iron-flex-factors"></style>

    <style>
      styled-dialog ::content .inside .styled-dialog-name {
        display: inline-block;
        /* Set the width to fit the "Document ID" text plus margin. */
        min-width: 105px;
      }
      .highlighted {
        font-weight: bold;
        background-color: yellow;
      }
      .confidence {
        cursor: pointer;
      }
    </style>

    <div class="layout horizontal center extraction-item">
      <span class$="confidence left [[_getConfidenceStyleClass(confidence)]]" title$="[[_getTitle(confidence)]]" on-tap="_toggleProvenanceDialog"></span>
      <span class$="confidence right [[_getConfidenceStyleClass(confidence)]]" title$="[[_getTitle(confidence)]]" on-tap="_toggleProvenanceDialog"></span>

      <styled-dialog id="provenanceDialog" header="Extraction Data Provenance" on-tap="_toggleProvenanceDialog">
        <template is="dom-if" if="[[!provenances]]">
          <div>None</div>
        </template>

        <template is="dom-if" if="[[provenances]]">
          <div><strong class="styled-dialog-name">Document ID</strong><span>[[documentId]]</span></div>
        </template>

        <template is="dom-repeat" items="[[provenances]]">
          <div class="styled-dialog-divider"></div>
          <div class="layout horizontal wrap">
            <strong class="styled-dialog-name">Text</strong>
            <template is="dom-repeat" items="[[_getContextTextSplit(item, provenanceTextProperty, highlightTag)]]">
              <span class="styled-dialog-right-space">
                <template is="dom-if" if$="[[_hasHighlight(item, highlightTag)]]">
                  <span class="highlighted">[[_stripTag(item, highlightTag)]]</span>
                </template>
                <template is="dom-if" if$="[[!_hasHighlight(item, highlightTag)]]">
                  [[item]]
                </template>
              </span>
            </template>
          </div>

          <div><strong class="styled-dialog-name">Method</strong><span>[[_getProperty(item, provenanceMethodProperty)]]</span></div>
        </template>
      </styled-dialog>
    </div>
  </template>

  <script>
  (function() {
    'use strict';
    Polymer({
      is: 'confidence-marker',

      properties: {
        /**
         * (Required)
         *
         * The confidence.
         *
         * @type {Number|String}
         * @default '0'
         */
        confidence: {
          type: String,
          value: '0'
        },

        /**
         * (Optional)
         *
         * The document ID.
         *
         * @type {String}
         * @default 'None'
         */
        documentId: {
          type: String,
          value: 'None'
        },

        /**
         * (Optional)
         *
         * The list of extraction provenance objects.
         *
         * @type {Array}
         * @default []
         */
        provenances: {
          type: String,
          value: function() {
            return [];
          }
        },

        /**
         * (Optional) 
         *
         * The property of the method in the provenance objects.
         *
         * @type {String}
         * @default 'method'
         */
        provenanceMethodProperty: {
          type: String,
          value: 'method'
        },

        /**
         * (Optional) 
         *
         * The property of the text in the provenance objects.
         *
         * @type {String}
         * @default 'text'
         */
        provenanceTextProperty: {
          type: Array,
          value: 'text'
        },

        /**
         * (Optional) 
         *
         * The highlight tag used in the provenance text.  Assumes the format:  `<highlightTag>text</highlightTag>`
         *
         * @type {String}
         * @default 'etk'
         */
        highlightTag: {
          type: String,
          value: 'etk'
        }
      },

      /**
       * Returns the object in the given item at the given property.
       *
       * @param {Object} item
       * @param {Array} property
       * @return {Object}
       * @private
       */
      _getProperty: function(item, property) {
        return item[property];
      },

      /**
       * Returns the title based on the given confidence.
       *
       * @param {String} confidence
       * @return {String}
       * @private
       */
      _getTitle: function(confidence) {
        return 'Confidence:  ' + confidence + '% (Click to See Provenance)';
      },

      /**
       * Opens the provenance dialog.
       *
       * @private
       */
      _toggleProvenanceDialog: function(e) {
        if(e) {
          e.stopPropagation();
        }
        this.$.provenanceDialog.open();
      },

      /**
       * Returns the provenance text as an array split so that highlighted tags are seperate from normal text.
       *
       * @param {Object} item
       * @return {Array}
       * @private
       */
      _getContextTextSplit: function(item, property, highlightTag) {
        if(!item[property]) {
          return ['None'];
        }
        // TODO Why do we need the <splithere> tags?
        return item[property]
          .replace(new RegExp('<' + highlightTag + '>', 'g') , '<splithere><' + highlightTag + '>')
          .replace(new RegExp('</' + highlightTag + '>', 'g') , '</' + highlightTag+'><splithere>')
          .split('<splithere>')
          .filter(function(text) {
            return !!text;
          });
      },

      /**
       * Returns if the text contains highlighted tags.
       *
       * @param {String} raw
       * @param {String} highlightTag
       * @return {Boolean}
       * @private
       */
      _hasHighlight: function(raw, highlightTag) {
        return (raw.indexOf('<' + highlightTag + '>') >= 0 && raw.indexOf('</' + highlightTag + '>') >= 0);
      },

      /**
       * Removes the highlighted tags from a string.
       *
       * @param {String} raw
       * @param {String} highlightTag
       * @return {String}
       * @private
       */
      _stripTag: function(raw, highlightTag) {
        var cut = raw.substring(raw.indexOf('<' + highlightTag + '>') + highlightTag.length + 2);
        return cut.substring(0, cut.indexOf('</' + highlightTag + '>')) || raw;
      },

      /**
       * Returns the style class of the confidence icon using the given confidence.
       *
       * @param {Number|String} confidence
       * @return {String}
       * @private
       */
      _getConfidenceStyleClass: function(confidence) {
        var confidenceNumber = Number(confidence);
        if(confidenceNumber > 99) {
          return 'full';
        }
        if(confidenceNumber > 66) {
          return 'high';
        }
        if(confidenceNumber > 33) {
          return 'med';
        }
        if(confidenceNumber > 0) {
          return 'low';
        }
        return (confidence === 0 || confidence === '0') ? 'no' : 'hide';
      }
    });
  })();
  </script>
</dom-module>
